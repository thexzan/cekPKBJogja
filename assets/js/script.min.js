$("#resultpanel").hide();

const merk = $("#merk");
const type = $("#type");
const tahun = $("#tahun");
const nilaijual = $("#nilaijual");
const pkb = $("#pkb");
const swdkllj = $("#swdkllj");
const total = $("#total");
const jatuhtempo = $("#jatuhtempo");

const formatRupiah = angka => {
  var number_string = angka.replace(/[^,\d]/g, "").toString(),
    split = number_string.split(","),
    sisa = split[0].length % 3,
    rupiah = split[0].substr(0, sisa),
    ribuan = split[0].substr(sisa).match(/\d{3}/gi);

  // tambahkan titik jika yang di input sudah menjadi angka ribuan
  if (ribuan) {
    separator = sisa ? "." : "";
    rupiah += separator + ribuan.join(".");
  }

  rupiah = split[1] != undefined ? rupiah + "," + split[1] : rupiah;
  return "Rp. " + rupiah;
};

const getPKB = () => {
  $("#resultpanel").hide();
  $("#howtopanel").show();

  let nopolisi = "";
  let cekPrefix = parseInt($("input").val().substring(0, 2));

  // CEK APAKAH INPUT ADA PREFIX AB NYA
  if (!isNaN(cekPrefix)) {
    //   KALAU GA ADA
    nopolisi = `AB${$("input").val().substring(4)}${$("input")
      .val()
      .substring(0, 4)}`;
  } else {
    //   KALAU ADA
    nopolisi = `AB${$("input").val().substring(6)}${$("input")
      .val()
      .substring(2, 6)}`;
  }

  $.ajax({
    url: "https://pkbjogja.netlify.app/.netlify/functions/getPKB",
    type: "POST",
    data: JSON.stringify({
      nopolisi
    })
  }).done(data => {
    if (data.status === "success") {
      const njkb = ((parseInt(data.data.pkb) / 3) * 200).toString();
      merk.text(data.data.nmmerekkb);
      type.text(data.data.nmmodelkb);
      tahun.text(data.data.tahunkb);
      pkb.text(formatRupiah(data.data.pkb));
      nilaijual.text(formatRupiah(njkb));
      swdkllj.text(formatRupiah(data.data.swdkllj));
      total.text(formatRupiah(data.data.pkbswd));
      jatuhtempo.text(data.data.tgakhirpkb);
      $("#resultpanel").show();
      $("#howtopanel").hide();
    } else {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "NOPOL Tidak ditemukan"
      });
    }
  });
};

$("form").submit(e => {
  e.preventDefault();
  getPKB();
});

$("#btncek").on("click", getPKB);
